@model DoableFinal.Models.Project

@{
    ViewData["Title"] = "Project Details";
    var dateFormat = "MMM dd, yyyy";
    var dateTimeFormat = "MMM dd, yyyy HH:mm";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Project Details</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a asp-controller="Employee" asp-action="Index">Dashboard</a></li>
        <li class="breadcrumb-item"><a asp-controller="Employee" asp-action="Projects">My Projects</a></li>
        <li class="breadcrumb-item active">Project Details</li>
    </ol>

    <div class="row">
        <div class="col-xl-8">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-project-diagram me-1"></i>
                    Project Information
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Name:</div>
                        <div class="col-md-9">@Model.Name</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Description:</div>
                        <div class="col-md-9">@Model.Description</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Project Manager:</div>
                        <div class="col-md-9">@($"{Model.ProjectManager.FirstName} {Model.ProjectManager.LastName}")</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Status:</div>
                        <div class="col-md-9">
                            <span class="badge bg-@(Model.Status switch {
                                "Not Started" => "secondary",
                                "In Progress" => "primary",
                                "On Hold" => "warning",
                                "Completed" => "success",
                                _ => "secondary"
                            })">@Model.Status</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Progress:</div>
                        <div class="col-md-9">
                            @{
                                var totalTasks = Model.Tasks?.Count ?? 0;
                                var completedTasks = Model.Tasks?.Count(t => t.Status == "Completed") ?? 0;
                            }
                            @completedTasks out of @totalTasks tasks completed
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Start Date:</div>
                        <div class="col-md-9">@Model.StartDate.ToString(dateFormat)</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">End Date:</div>
                        <div class="col-md-9">
                            @if (Model.EndDate.HasValue)
                            {
                                <span class="@(Model.EndDate.Value < DateTime.Now && Model.Status != "Completed" ? "text-danger" : "")">
                                    @Model.EndDate.Value.ToString(dateFormat)
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">Not set</span>
                            }
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Created:</div>
                        <div class="col-md-9">@Model.CreatedAt.ToString(dateTimeFormat)</div>
                    </div>
                    @if (Model.UpdatedAt.HasValue)
                    {
                        <div class="row mb-3">
                            <div class="col-md-3 fw-bold">Last Updated:</div>
                            <div class="col-md-9">@Model.UpdatedAt.Value.ToString(dateTimeFormat)</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Gantt Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-1"></i>
                    Project Timeline
                </div>
                <div class="card-body">
                    <div id="ganttChart"></div>
                </div>
            </div>

            <!-- Project Team -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-users me-1"></i>
                    Project Team
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Joined Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var member in Model.ProjectTeams)
                                {
                                    <tr>
                                        <td>
                                            @($"{member.User.FirstName} {member.User.LastName}")
                                            <a asp-controller="Message" asp-action="Index" asp-route-userId="@member.User.Id" title="Message" class="btn btn-sm btn-outline-secondary ms-2">
                                                <i class="bi bi-envelope"></i>
                                            </a>
                                        </td>
                                        <td>@member.Role</td>
                                        <td>@member.JoinedAt.ToString(dateFormat)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- My Tasks in this Project -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-tasks me-1"></i>
                    My Tasks in this Project
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                               @foreach (var task in Model.Tasks.Where(t => t.TaskAssignments.Any(a => a.EmployeeId == ViewBag.CurrentUserId)))
                                {
                                    <tr>
                                        <td>@task.Title</td>
                                        <td>
                                            <span class="@(task.DueDate < DateTime.Now && task.Status != "Completed" ? "text-danger" : "")">
                                                @task.DueDate.ToString(dateFormat)
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(task.Status switch {
                                                "Not Started" => "secondary",
                                                "In Progress" => "primary",
                                                "On Hold" => "warning",
                                                "Completed" => "success",
                                                _ => "secondary"
                                            })">@task.Status</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(task.Priority switch {
                                                "Low" => "info",
                                                "Medium" => "warning",
                                                "High" => "danger",
                                                _ => "secondary"
                                            })">@task.Priority</span>
                                        </td>
                                        <td>
                                            <a asp-controller="Employee" asp-action="TaskDetails" asp-route-id="@task.Id" 
                                               class="btn btn-sm btn-outline-primary">View</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> 

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get project start and end dates
            var projectStart = new Date("@Model.StartDate.ToString("yyyy-MM-dd")").getTime();
            var projectEnd = new Date("@Model.EndDate?.ToString("yyyy-MM-dd")").getTime();

            // Prepare task data
            var tasks = @Html.Raw(Json.Serialize(Model.Tasks?.Select(t => new {
                id = t.Id,
                name = t.Title ?? "Untitled Task",
                start = t.StartDate.ToString("yyyy-MM-dd"),
                end = t.DueDate.ToString("yyyy-MM-dd"),
                status = t.Status ?? "Not Set",
                assignee = t.TaskAssignments != null && t.TaskAssignments.Any()
                    ? string.Join(", ", t.TaskAssignments.Select(a => a.Employee.FirstName))
                    : "Unassigned"
            }) ?? Enumerable.Empty<object>()));

            // Configure colors array
            const colors = ['#FF5733', '#4834d4', '#6ab04c', '#be2edd', '#22a6b3', '#eb4d4b', '#f0932b', '#686de0', '#badc58', '#130f40'];

            // Create series data
            const seriesData = tasks.map((task, index) => ({
                name: task.name,
                data: [{
                    x: ' ',
                    y: [new Date(task.start).getTime(), new Date(task.end).getTime()],
                    status: task.status,
                    assignee: task.assignee
                }]
            }));

            // Configure the Gantt chart
            var options = {
                series: seriesData,
                chart: {
                    height: 150,
                    type: 'rangeBar',
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: false,
                            zoom: false,
                            zoomin: false,
                            zoomout: false,
                            pan: false,
                            reset: false
                        }
                    },
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800
                    },
                    fontFamily: 'inherit'
                },
                colors: ['#FF5733'],
                plotOptions: {
                    bar: {
                        horizontal: true,
                        barHeight: '50%',
                        rangeBarGroupRows: true,
                        borderRadius: 4
                    }
                },
                dataLabels: {
                    enabled: false
                },
                colors: colors,
                xaxis: {
                    type: 'datetime',
                    min: projectStart,
                    max: projectEnd,
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: 'MMM yyyy',
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    }
                },
                yaxis: {
                    show: false,
                    labels: {
                        show: false
                    }
                },
                grid: {
                    row: {
                        colors: ['#f8f9fa', '#fff'],
                        opacity: 1
                    },
                    padding: {
                        top: -10,
                        right: 0,
                        bottom: -10,
                        left: 0
                    }
                },
                tooltip: {
                    custom: function({series, seriesIndex, dataPointIndex, w}) {
                        var task = w.config.series[seriesIndex].data[0];
                        var startDate = new Date(task.y[0]).toLocaleDateString();
                        var endDate = new Date(task.y[1]).toLocaleDateString();
                        return '<div class="px-3 py-2">' +
                               '<div class="mb-2"><strong>' + w.config.series[seriesIndex].name + '</strong></div>' +
                               '<div class="text-muted small">Duration: ' + startDate + ' - ' + endDate + '</div>' +
                               '<div class="mt-2"><span class="badge bg-' + 
                               (task.status === 'Completed' ? 'success' : 
                                task.status === 'In Progress' ? 'primary' : 
                                task.status === 'On Hold' ? 'warning' : 'secondary') + 
                               ' me-1">' + task.status + '</span>' +
                               (task.assignee !== 'Unassigned' ? '<span class="badge bg-info ms-1"><i class="bi bi-person me-1"></i>' + task.assignee + '</span>' : '') +
                               '</div>' +
                               '</div>';
                    }
                },
                legend: {
                    show: true,
                    position: 'top',
                    horizontalAlign: 'left',
                    fontSize: '13px',
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 2,
                        fillColors: colors
                    },
                    labels: {
                        colors: '#333'
                    },
                    itemMargin: {
                        horizontal: 15
                    },
                    containerMargin: {
                        top: 0,
                        bottom: 15
                    }
                }
            };

            // Render the chart
            var chart = new ApexCharts(document.querySelector("#ganttChart"), options);
            chart.render();
        });
    </script>
}