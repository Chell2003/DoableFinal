@model IEnumerable<DoableFinal.Models.Message>

@{
    ViewData["Title"] = "Messages";

    if (User.IsInRole("Admin"))
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
    else if (User.IsInRole("Client"))
    {
        Layout = "~/Views/Shared/_ClientLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
}

<div class="container-fluid px-4 py-3">
    <div class="row g-3">
        <!-- Message List Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 rounded-3 h-100">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold mb-0">
                            <i class="bi bi-chat-dots-fill text-primary me-2"></i>Messages
                        </h4>
                        <button id="btnNewMessage" type="button" class="btn btn-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                            <i class="bi bi-plus-lg me-1"></i> New
                        </button>
                    </div>
                    
                    @if (ViewBag.Projects != null && ViewBag.Projects.Count > 0)
                    {
                        <div class="mb-2">
                            <select id="projectFilter" class="form-select rounded-pill" onchange="filterByProject()">
                                <option value="">All Projects</option>
                                @foreach (var project in ViewBag.Projects)
                                {
                                    @if (ViewBag.SelectedProjectId == project.Id)
                                    {
                                        <option value="@project.Id" selected>@project.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@project.Id">@project.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    }
                </div>
                
                <div class="card-body p-0">
                    <div class="list-group list-group-flush conversation-list" style="height: calc(100vh - 280px); overflow-y: auto;">
                        @{ 
                            var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value; 
                            var isEmployee = User.IsInRole("Employee"); 
                        }

                        @if (ViewBag.UsersWithMessages != null)
                        {
                            foreach (var conv in ViewBag.UsersWithMessages)
                            {
                                if (conv == null) continue;
                                if (conv.UserId == currentUserId) continue;
                                if (conv.User == null) continue;
                                if (isEmployee && conv.User.Role == "Client") continue;
                                
                                <div class="conversation-item px-3 py-3 border-bottom position-relative @(conv.UnreadCount > 0 ? "unread-item" : "")" 
                                    data-userid="@conv.UserId"
                                    style="cursor: pointer; transition: all 0.2s ease;" 
                                    onclick="loadConversation('@conv.UserId')">
                                    <div class="d-flex align-items-start gap-3">
                                        <div class="avatar-circle flex-shrink-0">
                                            <span class="avatar-initials">@conv.User.FirstName.Substring(0,1)@conv.User.LastName.Substring(0,1)</span>
                                        </div>
                                        <div class="flex-grow-1 min-w-0">
                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                <h6 class="mb-0 fw-semibold text-truncate">@conv.User.FirstName @conv.User.LastName</h6>
                                                <small class="text-muted flex-shrink-0 ms-2">@conv.LastMessage.CreatedAt.ToString("MMM dd")</small>
                                            </div>
                                            <span class="badge bg-light text-secondary mb-1" style="font-size: 0.7rem;">@conv.User.Role</span>
                                            <p class="mb-0 text-truncate text-muted small" style="max-width: 100%;">
                                                @if(conv.LastMessage.SenderId == currentUserId) 
                                                { 
                                                    <span class="text-primary fw-medium">You: </span>
                                                }
                                                @conv.LastMessage.Content
                                            </p>
                                        </div>
                                        @if (conv.UnreadCount > 0)
                                        {
                                            <span class="badge bg-primary rounded-circle position-absolute" style="top: 12px; right: 12px; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">@conv.UnreadCount</span>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        
                        @foreach (var user in ViewBag.UsersWithoutMessages)
                        {
                            @if (user.Id == currentUserId) { continue; }
                            @if (isEmployee && user.Role == "Client") { continue; }
                            
                            <div class="conversation-item px-3 py-3 border-bottom" 
                                data-userid="@user.Id"
                                style="cursor: pointer; transition: all 0.2s ease;" 
                                onclick="loadConversation('@user.Id')">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="avatar-circle flex-shrink-0">
                                        <span class="avatar-initials">@user.FirstName.Substring(0,1)@user.LastName.Substring(0,1)</span>
                                    </div>
                                    <div class="flex-grow-1 min-w-0">
                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                            <h6 class="mb-0 fw-semibold text-truncate">@user.FirstName @user.LastName</h6>
                                        </div>
                                        <span class="badge bg-light text-secondary mb-1" style="font-size: 0.7rem;">@user.Role</span>
                                        <p class="mb-0 text-muted small fst-italic">No messages yet</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Content Area -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 rounded-3 h-100">
                <div class="card-body p-0">
                    <div id="conversationContent" class="d-flex flex-column" style="height: calc(100vh - 200px); overflow: visible;">
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <div class="empty-state-icon mb-3">
                                <i class="bi bi-chat-dots" style="font-size: 4rem; opacity: 0.3;"></i>
                            </div>
                            <h5 class="fw-semibold mb-2">No conversation selected</h5>
                            <p class="text-center">Choose a conversation from the list to start messaging</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" aria-labelledby="newMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="newMessageModalLabel">
                    <i class="bi bi-send-fill text-primary me-2"></i>New Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-2">
                <form id="newMessageForm" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="receiverId" class="form-label fw-semibold small text-muted">Recipient</label>
                        <select id="receiverId" name="receiverId" class="form-select rounded-pill" required>
                            <option value="">Select recipient...</option>
                            @{ 
                                var renderedUserIds = new HashSet<string>();
                                if (ViewBag.UsersWithMessages != null) {
                                    foreach (var conv in ViewBag.UsersWithMessages) {
                                        if (conv == null) continue;
                                        if (conv.UserId == currentUserId) continue;
                                        if (conv.User == null) continue;
                                        if (isEmployee && conv.User.Role == "Client") continue;
                                        if (renderedUserIds.Add(conv.User.Id)) {
                                            <option value="@conv.User.Id">@conv.User.FirstName @conv.User.LastName (@conv.User.Role)</option>
                                        }
                                    }
                                }
                                if (ViewBag.UsersWithoutMessages != null) {
                                    foreach (var u in ViewBag.UsersWithoutMessages) {
                                        if (u.Id == currentUserId) continue;
                                        if (isEmployee && u.Role == "Client") continue;
                                        if (renderedUserIds.Add(u.Id)) {
                                            <option value="@u.Id">@u.FirstName @u.LastName (@u.Role)</option>
                                        }
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="projectId" class="form-label fw-semibold small text-muted">Project <span class="text-muted fw-normal">(optional)</span></label>
                        <select id="projectId" name="projectId" class="form-select rounded-pill">
                            <option value="">Select project...</option>
                            @if (ViewBag.Projects != null)
                            {
                                foreach (var project in ViewBag.Projects)
                                {
                                    <option value="@project.Id">@project.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="messageContent" class="form-label fw-semibold small text-muted">Message</label>
                        <textarea id="messageContent" name="content" class="form-control rounded-3" rows="4" placeholder="Type your message here..." required style="resize: none;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button id="btnSendNew" type="button" class="btn btn-primary rounded-pill px-4">
                    <i class="bi bi-send-fill me-1"></i> Send
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        })()

        const authUserIdRaw = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';
        const authUserId = (authUserIdRaw || '').trim();
        let currentConversationUserId = null;

        function loadConversation(userId) {
            currentConversationUserId = userId;
            document.querySelectorAll('.conversation-item').forEach(it => it.classList.remove('active'));
            const activeItem = document.querySelector(`.conversation-item[data-userid="${userId}"]`);
            if (activeItem) activeItem.classList.add('active');
            const content = document.getElementById('conversationContent');
            content.innerHTML = `
                <div class="conversation-header p-4 border-bottom bg-light">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h6 class="mb-0 text-muted">Loading conversation...</h6>
                    </div>
                </div>
            `;

            refreshConversation(userId);
        }

        function refreshConversation(userId) {
            fetch(`/Message/GetConversation?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    const messages = data.messages;
                    const messagesHtml = messages.map(message => {
                        const isSent = message.senderId === authUserId;
                        return `
                            <div class="message-wrapper ${isSent ? 'message-wrapper-sent' : 'message-wrapper-received'}">
                                <div class="message-bubble ${isSent ? 'message-sent' : 'message-received'}">
                                    ${message.projectId ? `
                                        <div class="message-project-tag">
                                            <i class="bi bi-folder-fill me-1"></i>${message.projectName || 'Project'}
                                        </div>
                                    ` : ''}
                                    <div class="message-content">${message.content}</div>
                                    <div class="message-time">${message.createdAt}</div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const content = document.getElementById('conversationContent');
                    const recipientElem = document.querySelector(`.conversation-item[data-userid="${userId}"]`);
                    const recipientName = recipientElem ? (recipientElem.querySelector('h6') ? recipientElem.querySelector('h6').innerText : 'Conversation') : 'Conversation';
                    
                    content.innerHTML = `
                        <div class="conversation-header p-3 border-bottom bg-white">
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle-header me-3">
                                    <span class="avatar-initials">${recipientName.split(' ').map(n => n[0]).join('').substring(0,2)}</span>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-semibold">${recipientName}</h5>
                                    <small class="text-success"><i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Online</small>
                                </div>
                            </div>
                        </div>
                        <div class="conversation-messages p-4" style="overflow-y: auto; flex: 1; background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);">
                            ${messagesHtml || '<div class="text-center text-muted py-5"><i>No messages yet. Start the conversation!</i></div>'}
                        </div>
                        <div class="conversation-input p-3 border-top bg-white">
                            <form id="messageForm" class="needs-validation" novalidate>
                                <input type="hidden" name="receiverId" value="${userId}" />
                                <div class="input-group">
                                    <textarea name="content" class="form-control border-0 shadow-none" rows="1" 
                                            placeholder="Type your message..." required style="resize: none; background: #f8f9fa; border-radius: 24px; padding: 12px 20px;"></textarea>
                                    <button type="submit" class="btn btn-primary rounded-circle ms-2" style="width: 48px; height: 48px; padding: 0;">
                                        <i class="bi bi-send-fill"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;

                    const messagesContainer = content.querySelector('.conversation-messages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    const form = document.getElementById('messageForm');
                    form.addEventListener('submit', async function (event) {
                        event.preventDefault();
                        
                        if (!form.checkValidity()) {
                            event.stopPropagation();
                            form.classList.add('was-validated');
                            return;
                        }

                        const formData = new FormData(form);
                        try {
                            const response = await fetch('/Message/SendMessage', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: new URLSearchParams(formData),
                            });

                            if (response.ok) {
                                form.reset();
                                form.classList.remove('was-validated');
                                refreshConversation(userId);
                            }
                        } catch (error) {
                            console.error('Error sending message:', error);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading conversation:', error);
                });
        }

        setInterval(() => {
            if (currentConversationUserId) {
                refreshConversation(currentConversationUserId);
            }
        }, 10000);

        var receiverElement = document.getElementById('receiverId');
        if (receiverElement) {
            receiverElement.addEventListener('change', function (e) {
                const recipientId = e.target.value;
                const projectSelect = document.getElementById('projectId');

                if (!recipientId) {
                    projectSelect.innerHTML = '<option value="">Select project...</option>';
                    return;
                }

                fetch(`/Message/GetSharedProjects?recipientId=${recipientId}`)
                    .then(r => r.json())
                    .then(data => {
                        projectSelect.innerHTML = '<option value="">Select project...</option>';
                        if (Array.isArray(data) && data.length > 0) {
                            data.forEach(function (p) {
                                const opt = document.createElement('option');
                                opt.value = p.id || p.Id || '';
                                opt.text = p.name || p.Name || '';
                                projectSelect.appendChild(opt);
                            });
                        }
                    })
                    .catch(err => console.error('Failed to load shared projects', err));
            });
        }

        function filterByProject() {
            const projectId = document.getElementById('projectFilter').value;
            const url = projectId ? `/Message/Index?projectId=${projectId}` : '/Message/Index';
            window.location.href = url;
        }

        const btnSendNew = document.getElementById('btnSendNew');
        if (btnSendNew) {
            btnSendNew.addEventListener('click', async function () {
                const form = document.getElementById('newMessageForm');
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                const formData = new FormData(form);
                try {
                    const response = await fetch('/Message/SendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams(formData)
                    });

                    if (response.ok) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('newMessageModal'));
                        if (modal) modal.hide();
                        form.reset();
                        form.classList.remove('was-validated');
                        const rid = formData.get('receiverId');
                        if (rid) {
                            loadConversation(rid);
                        }
                    }
                } catch (err) {
                    console.error('Error sending new message:', err);
                }
            });
        }

        const btnNewMessageElem = document.getElementById('btnNewMessage');
        if (btnNewMessageElem) {
            btnNewMessageElem.addEventListener('click', function () {
                const receiverSelect = document.getElementById('receiverId');
                if (receiverSelect) {
                    if (currentConversationUserId) {
                        receiverSelect.value = currentConversationUserId;
                        receiverSelect.dispatchEvent(new Event('change'));
                    } else {
                        receiverSelect.value = '';
                    }
                }
            });
        }
    </script>

    <style>
        /* Modern Avatar Styling */
        .avatar-circle {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .avatar-circle-header {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .avatar-initials {
            text-transform: uppercase;
        }

        /* Enhanced Conversation List */
        .conversation-list::-webkit-scrollbar {
            width: 6px;
        }

        .conversation-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .conversation-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .conversation-list::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .conversation-item {
            transition: all 0.2s ease;
        }

        .conversation-item:hover {
            background-color: #f8f9fa;
            transform: translateX(2px);
        }

        .conversation-item.active {
            background: linear-gradient(to right, #e3f2fd 0%, #f8f9fa 100%);
            border-left: 3px solid #0d6efd;
        }

        .conversation-item.unread-item {
            background-color: #f0f7ff;
        }

        /* Modern Message Bubbles */
        .conversation-messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-wrapper {
            display: flex;
            width: 100%;
        }

        .message-wrapper-sent {
            justify-content: flex-end;
        }

        .message-wrapper-received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 65%;
            padding: 10px 16px;
            border-radius: 18px;
            position: relative;
            animation: messageSlideIn 0.3s ease;
        }

        @@keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-sent {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
        }

        .message-received {
            background: #f1f3f5;
            color: #212529;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .message-content {
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-time {
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.75;
        }

        .message-sent .message-time {
            text-align: right;
            color: rgba(255, 255, 255, 0.9);
        }

        .message-received .message-time {
            color: rgba(0, 0, 0, 0.5);
        }

        .message-project-tag {
            font-size: 0.75rem;
            margin-bottom: 6px;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: inline-block;
        }

        .message-sent .message-project-tag {
            background: rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 0.95);
        }

        .message-received .message-project-tag {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.6);
        }

        /* Enhanced Input Area */
        .conversation-input textarea {
            transition: all 0.2s ease;
        }

        .conversation-input textarea:focus {
            background: #fff !important;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1) !important;
        }

        /* Card Enhancements */
        .card {
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08) !important;
        }

        /* Button Enhancements */
        .btn-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0a58ca 0%, #084298 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
        }

        /* Modal Enhancements */
        .modal-content {
            border-radius: 16px;
            overflow: hidden;
        }

        /* Responsive Design */
        @@media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
            }

            .col-lg-4, .col-lg-8 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
        }

        /* Empty State */
        .empty-state-icon {
            animation: float 3s ease-in-out infinite;
        }

        @@keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Badge Enhancements */
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
        }

        /* Smooth Scrolling */
        .conversation-messages {
            scroll-behavior: smooth;
        }
    </style>
}