@model IEnumerable<DoableFinal.Models.Message>

@{
    ViewData["Title"] = "Messages";

    if (User.IsInRole("Admin"))
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
    else if (User.IsInRole("Client"))
    {
        Layout = "~/Views/Shared/_ClientLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_Layout.cshtml"; // or Layout = null
    }
}

<!-- Role-based Navbar -->


<div class="container-fluid">
    <div class="row">        <!-- Message List Sidebar -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="card-title mb-0">Conversations</h5>
                        <div>
                            <button id="btnNewMessage" type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                                <i class="bi bi-plus-lg"></i> New
                            </button>
                        </div>
                    </div>
                    @* Project filter dropdown for Clients and Project Managers *@
                    @if (ViewBag.Projects != null && ViewBag.Projects.Count > 0)
                    {
                        <div class="mb-2">
                            <select id="projectFilter" class="form-select form-select-sm" onchange="filterByProject()">
                                <option value="">All Projects</option>
                                @foreach (var project in ViewBag.Projects)
                                {
                                    @if (ViewBag.SelectedProjectId == project.Id)
                                    {
                                        <option value="@project.Id" selected>@project.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@project.Id">@project.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    }
                </div>
                    <div class="card-body p-0">                            
                    <div class="list-group list-group-flush" style="height: calc(100vh - 250px); overflow-y: auto;">
                                @{ var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value; var isEmployee = User.IsInRole("Employee"); }

                                @if (ViewBag.UsersWithMessages != null)
                                {
                                    foreach (var conv in ViewBag.UsersWithMessages)
                                    {
                                        if (conv == null) continue;
                                        if (conv.UserId == currentUserId) continue; // don't show conversation with self
                                        if (conv.User == null) continue;
                                        if (isEmployee && conv.User.Role == "Client") continue; // employees should not see clients
                                        <div class="conversation-item p-3 border-bottom @(conv.UnreadCount > 0 ? "bg-light" : "")" 
                                            data-userid="@conv.UserId"
                                            style="cursor: pointer;" 
                                            onclick="loadConversation('@conv.UserId')">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle me-3">
                                                    <i class="bi bi-person-fill"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">@conv.User.FirstName @conv.User.LastName (@conv.User.Role)</h6>
                                                        <small class="text-muted">@conv.LastMessage.CreatedAt.ToString("MMM dd")</small>
                                                    </div>
                                                    <p class="mb-0 text-truncate" style="max-width: 200px;">
                                                        @(conv.LastMessage.SenderId == currentUserId ? "You: " : "")@conv.LastMessage.Content
                                                    </p>
                                                </div>
                                                @if (conv.UnreadCount > 0)
                                                {
                                                    <span class="badge bg-primary rounded-pill ms-2">@conv.UnreadCount</span>
                                                }
                                            </div>
                                        </div>
                                    }                                }
                                
                                  @foreach (var user in ViewBag.UsersWithoutMessages)
                                {
                                      @if (user.Id == currentUserId) { continue; }
                                      @if (isEmployee && user.Role == "Client") { continue; }
                                      <div class="conversation-item p-3 border-bottom" 
                                         data-userid="@user.Id"
                                         style="cursor: pointer;" 
                                         onclick="loadConversation('@user.Id')">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-3">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">@user.FirstName @user.LastName (@user.Role)</h6>
                                                </div>
                                                <p class="mb-0 text-muted">No messages yet</p>
                                            </div>
                                        </div>
                                    </div>
                                }                            </div>
                </div>
            </div>
        </div>

        <!-- Message Content Area -->
        <div class="col-md-8">
            <div class="card shadow-sm">
            <div class="card-body p-0">
                <!-- Make this area full viewport height -->
                <div id="conversationContent" class="d-flex flex-column" style="height: calc(100vh - 250px); overflow: visible;">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-chat-dots display-1"></i>
                    <p class="mt-3">Select a conversation to view messages</p>
                </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" aria-labelledby="newMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newMessageModalLabel">New Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newMessageForm" class="needs-validation" novalidate>
                    <div class="mb-2">
                        <label for="receiverId" class="form-label small">To</label>
                        <select id="receiverId" name="receiverId" class="form-select form-select-sm" required>
                            <option value="">Select recipient...</option>
                            @* Combine users from both lists; avoid duplicates *@
                            @{ 
                                var renderedUserIds = new HashSet<string>();
                                if (ViewBag.UsersWithMessages != null) {
                                    foreach (var conv in ViewBag.UsersWithMessages) {
                                        if (conv == null) continue;
                                        if (conv.UserId == currentUserId) continue;
                                        if (conv.User == null) continue;
                                        if (isEmployee && conv.User.Role == "Client") continue; // employees shouldn't message clients
                                        if (renderedUserIds.Add(conv.User.Id)) {
                                            <option value="@conv.User.Id">@conv.User.FirstName @conv.User.LastName (@conv.User.Role)</option>
                                        }
                                    }
                                }
                                if (ViewBag.UsersWithoutMessages != null) {
                                    foreach (var u in ViewBag.UsersWithoutMessages) {
                                        if (u.Id == currentUserId) continue;
                                        if (isEmployee && u.Role == "Client") continue;
                                        if (renderedUserIds.Add(u.Id)) {
                                            <option value="@u.Id">@u.FirstName @u.LastName (@u.Role)</option>
                                        }
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="projectId" class="form-label small">Project (optional)</label>
                        <select id="projectId" name="projectId" class="form-select form-select-sm">
                            <option value="">Optional: Select project...</option>
                            @if (ViewBag.Projects != null)
                            {
                                foreach (var project in ViewBag.Projects)
                                {
                                    <option value="@project.Id">@project.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="messageContent" class="form-label small">Message</label>
                        <textarea id="messageContent" name="content" class="form-control" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnSendNew" type="button" class="btn btn-primary">Send</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Form validation
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        })()

        // Authentication user id (current signed-in user)
        const authUserIdRaw = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';
        const authUserId = (authUserIdRaw || '').trim();
        // The other party in the currently opened conversation
        let currentConversationUserId = null;

        function loadConversation(userId) {
            currentConversationUserId = userId;
            // Highlight the active conversation item
            document.querySelectorAll('.conversation-item').forEach(it => it.classList.remove('active'));
            const activeItem = document.querySelector(`.conversation-item[data-userid="${userId}"]`);
            if (activeItem) activeItem.classList.add('active');
            const content = document.getElementById('conversationContent');
            content.innerHTML = `
                <div class="conversation-header p-3 border-bottom">
                    <h5 class="mb-0">Loading conversation...</h5>
                </div>
                <div class="conversation-messages p-3 flex-grow-1" style="overflow-y: auto;">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            `;

            refreshConversation(userId);
        }

        function refreshConversation(userId) {
            fetch(`/Message/GetConversation?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    const messages = data.messages;
                    const messagesHtml = messages.map(message => {
                        const isSent = message.senderId === authUserId;
                        console.debug('message', message.senderId, 'auth', authUserId, 'isSent', isSent);
                        return `
                            <div class="d-flex ${isSent ? 'justify-content-end' : 'justify-content-start'}">
                                <div class="message-bubble ${isSent ? 'message-sent text-end' : 'message-received text-start'}">
                                    ${message.projectId ? `
                                        <div class="small text-${isSent ? 'light' : 'muted'} mb-1">
                                            <i class="bi bi-folder me-1"></i>${message.projectName || 'Project'}
                                        </div>
                                    ` : ''}
                                    <div class="message-content">${message.content}</div>
                                    <div class="small text-${isSent ? 'light' : 'muted'} mt-1">
                                        ${message.createdAt}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const content = document.getElementById('conversationContent');
                    const recipientElem = document.querySelector(`.conversation-item[data-userid="${userId}"]`);
                    const recipientName = recipientElem ? (recipientElem.querySelector('h6') ? recipientElem.querySelector('h6').innerText : 'Conversation') : 'Conversation';
                    content.innerHTML = `
                                <div class="conversation-header p-3 border-bottom d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle me-3"><i class="bi bi-person-fill"></i></div>
                                <h5 class="mb-0">${recipientName}</h5>
                            </div>
                            
                        </div>
                        <div class="conversation-messages p-3 flex-grow-1 d-flex flex-column" style="overflow-y: auto; width: 100%;">
                            ${messagesHtml}
                        </div>
                        <div class="conversation-input p-3 border-top">
                            <form id="messageForm" class="needs-validation" novalidate>
                                <input type="hidden" name="receiverId" value="${userId}" />
                                <div class="input-group">
                                    <textarea name="content" class="form-control" rows="1" 
                                            placeholder="Type a message..." required></textarea>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;

                    // Scroll to bottom
                    const messagesContainer = content.querySelector('.conversation-messages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    // Add form submission handler
                    const form = document.getElementById('messageForm');
                    form.addEventListener('submit', async function (event) {
                        event.preventDefault();
                        
                        if (!form.checkValidity()) {
                            event.stopPropagation();
                            form.classList.add('was-validated');
                            return;
                        }

                        const formData = new FormData(form);
                        try {
                            const response = await fetch('/Message/SendMessage', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: new URLSearchParams(formData),
                            });

                            if (response.ok) {
                                form.reset();
                                form.classList.remove('was-validated');
                                refreshConversation(userId);
                            } else {
                                console.error('Failed to send message');
                            }
                        } catch (error) {
                            console.error('Error sending message:', error);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading conversation:', error);
                    content.innerHTML = `
                        <div class="conversation-header p-3 border-bottom">
                            <h5 class="mb-0">Error</h5>
                        </div>
                        <div class="conversation-messages p-3 flex-grow-1">
                            <div class="alert alert-danger">
                                Failed to load conversation. Please try again.
                            </div>
                        </div>
                    `;
                });
        }

        // Auto-refresh conversation every 10 seconds
        setInterval(() => {
            if (currentConversationUserId) {
                refreshConversation(currentConversationUserId);
            }
        }, 10000);

        // Update project dropdown to only show projects shared between current user and selected recipient
        var receiverElement = document.getElementById('receiverId');
        if (receiverElement) {
            receiverElement.addEventListener('change', function (e) {
            const recipientId = e.target.value;
            const projectSelect = document.getElementById('projectId');

            // Reset to default if no recipient
            if (!recipientId) {
                projectSelect.innerHTML = '<option value="">Select project...</option>';
                @* Re-populate with initial projects from server-side ViewBag *@
                var initialOptions = `@Html.Raw(Json.Serialize(ViewBag.Projects ?? new List<object>()))`;
                try {
                    var opts = JSON.parse(initialOptions);
                    opts.forEach(function(p) {
                        const opt = document.createElement('option');
                        opt.value = p.Id;
                        opt.text = p.Name;
                        projectSelect.appendChild(opt);
                    });
                } catch (err) {
                    // fallback: do nothing
                }
                return;
            }

            fetch(`/Message/GetSharedProjects?recipientId=${recipientId}`)
                .then(r => r.json())
                .then(data => {
                    projectSelect.innerHTML = '<option value="">Select project...</option>';
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(function (p) {
                            const opt = document.createElement('option');
                            opt.value = p.id || p.Id || '';
                            opt.text = p.name || p.Name || '';
                            projectSelect.appendChild(opt);
                        });
                    }
                })
                .catch(err => {
                    console.error('Failed to load shared projects', err);
                });
            });
        }

        // Filter messages by project
        function filterByProject() {
            const projectId = document.getElementById('projectFilter').value;
            const url = projectId ? `/Message/Index?projectId=${projectId}` : '/Message/Index';
            window.location.href = url;
        }

        // Open user profile (best effort URL, may vary by app routes)
        function openRecipientProfile(userId) {
            if (!userId) return;
            // Try common profile routes, fallback to a query param route
            const possiblePaths = [`/User/Profile/${userId}`, `/Profile?userId=${userId}`, `/Account/Profile?userId=${userId}`];
            // Navigate to the first path (server should handle routing or return valid page)
            window.location.href = possiblePaths[0];
        }

        // Send new message from modal
        const btnSendNew = document.getElementById('btnSendNew');
        if (btnSendNew) {
            btnSendNew.addEventListener('click', async function () {
                const form = document.getElementById('newMessageForm');
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                const formData = new FormData(form);
                try {
                    const response = await fetch('/Message/SendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams(formData)
                    });

                    if (response.ok) {
                        // close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('newMessageModal'));
                        if (modal) modal.hide();
                        // reset and mark invalid cleared
                        form.reset();
                        form.classList.remove('was-validated');
                        // open the conversation with the selected recipient
                        const rid = formData.get('receiverId');
                        if (rid) {
                            loadConversation(rid);
                        }
                    } else {
                        console.error('Failed to send new message');
                    }
                } catch (err) {
                    console.error('Error sending new message:', err);
                }
            });
        }

        // Prefill new message modal with currently selected conversation recipient
        const btnNewMessageElem = document.getElementById('btnNewMessage');
        if (btnNewMessageElem) {
            btnNewMessageElem.addEventListener('click', function () {
                const receiverSelect = document.getElementById('receiverId');
                if (receiverSelect) {
                    if (currentConversationUserId) {
                        receiverSelect.value = currentConversationUserId;
                        // trigger change event to update projects
                        const event = new Event('change');
                        receiverSelect.dispatchEvent(event);
                    } else {
                        receiverSelect.value = '';
                    }
                }
            });
        }
    </script>

    <style>
        .avatar-circle {
            width: 40px;
            height: 40px;
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .avatar-circle i {
            font-size: 1.1rem;
            line-height: 1;
        }

        .conversation-item:hover {
            background-color: #f8f9fa;
        }

        .conversation-item.active {
            background-color: #e9ecef;
        }

        .message-bubble {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            display: inline-flex;
            flex-direction: column;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .conversation-header .avatar-circle {
            width: 44px;
            height: 44px;
            font-size: 1rem;
        }

        .conversation-messages {
            padding-right: 10px;
            display: flex;
            flex-direction: column;
            padding-bottom: 8px;
            gap: 6px;
        }

        .conversation-input textarea {
            resize: none;
        }

        .message-sent {
            background-color: #0d6efd;
            color: #ffffff;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
            border-top-right-radius: 15px;
            border-top-left-radius: 15px;
            padding-right: 12px;
            padding-left: 12px;
        }

        .message-received {
            background-color: #f1f3f5;
            color: #212529;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            padding-right: 12px;
            padding-left: 12px;
        }

        .message-bubble .message-content { font-size: 14px; }
        .message-bubble .small { opacity: 0.8; font-size: 12px; }
        .message-sent .small { color: rgba(255,255,255,0.9); }
        .message-received .small { color: rgba(0,0,0,0.55); }
    </style>
}