@model DoableFinal.Models.Project

@{
    ViewData["Title"] = "Project Details";
    var dateFormat = "MMM dd, yyyy";
    var dateTimeFormat = "MMM dd, yyyy HH:mm";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Project Details</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a asp-controller="ProjectManager" asp-action="MyProjects">Projects</a></li>
        <li class="breadcrumb-item active">Project Details</li>
    </ol>

    <div class="row">
        <!-- Project Information -->
        <div class="col-xl-8">
            <div class="card mb-4">
                <div id="projectActions" class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-project-diagram me-1"></i>
                        Project Information
                    </div>
                    <div>
                        @{
                            var totalTasks = Model.Tasks?.Count ?? 0;
                            var completedTasks = Model.Tasks?.Count(t => t.Status == "Completed") ?? 0;
                            var projectProgress = totalTasks > 0 ? (int)Math.Round((double)completedTasks / totalTasks * 100) : 0;
                        }
                        @if (!Model.IsArchived)
                        {
                            @if (projectProgress == 100 && Model.Status != "Completed")
                            {
                                <form id="completeProjectForm" asp-action="CompleteProject" asp-route-id="@Model.Id" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-success btn-sm me-2">
                                        <i class="fas fa-check-circle"></i> Complete Project
                                    </button>
                                </form>
                            }
                            @if (Model.Status != "In Progress")
                            {
                                <form id="archiveProjectForm" asp-action="ArchiveProject" asp-route-id="@Model.Id" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to archive this project?');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-warning btn-sm">
                                        <i class="fas fa-archive"></i> Archive Project
                                    </button>
                                </form>
                            }
                        }
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Name:</div>
                        <div class="col-md-9">@Model.Name</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Description:</div>
                        <div class="col-md-9">@Model.Description</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Client:</div>
                        <div class="col-md-9">@($"{Model.Client.FirstName} {Model.Client.LastName}")
                        @if (Model.ProjectManager.Id != ViewBag.CurrentUserId)
                                        {
                                            <a asp-controller="Message" asp-action="Index" asp-route-userId="@Model.ProjectManager.Id" title="Message" class="btn btn-sm btn-outline-secondary ms-2">
                                                <i class="bi bi-envelope"></i>
                                            </a>
                                        }
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Status:</div>
                        <div class="col-md-9">
                            <span id="projectStatusBadge" class="badge bg-@(Model.Status switch {
                                "Not Started" => "secondary",
                                "In Progress" => "primary",
                                "On Hold" => "warning",
                                "Completed" => "success",
                                _ => "secondary"
                            })">@Model.Status</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Progress:</div>
                        <div class="col-md-9">
                            @completedTasks out of @totalTasks tasks completed
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Start Date:</div>
                        <div class="col-md-9">@Model.StartDate.ToString(dateFormat)</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">End Date:</div>
                        <div class="col-md-9">
                            @if (Model.EndDate.HasValue)
                            {
                                <span class="@(Model.EndDate.Value < DateTime.Now && Model.Status != "Completed" ? "text-danger" : "")">
                                    @Model.EndDate.Value.ToString(dateFormat)
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">Not set</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gantt Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-1"></i>
                    Project Timeline
                </div>
                <div class="card-body">
                    <div id="ganttChart"></div>
                </div>
            </div>

            <!-- Project Tasks -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-tasks me-1"></i>
                        Project Tasks
                    </div>
                    @if (!Model.IsArchived)
                    {
                        <a id="createTaskBtn" asp-action="CreateTask" asp-route-projectId="@Model.Id" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-lg"></i> Create Task
                        </a>
                    }
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Assigned To</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var task in Model.Tasks ?? Enumerable.Empty<ProjectTask>())
                                {
                                    <tr>
                                        <td>@task.Title</td>
                                        <td>@(task.TaskAssignments != null && task.TaskAssignments.Any()
                                            ? string.Join(", ", task.TaskAssignments.Select(a => a.Employee.FirstName))
                                            : "Unassigned")
                                        </td>
                                        <td>
                                            <span class="@(task.DueDate < DateTime.Now && task.Status != "Completed" ? "text-danger" : "")">
                                                @task.DueDate.ToString(dateFormat)
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(task.Status switch {
                                                "Not Started" => "secondary",
                                                "In Progress" => "primary",
                                                "On Hold" => "warning",
                                                "Completed" => "success",
                                                _ => "secondary"
                                            })">@task.Status</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(task.Priority switch {
                                                "Low" => "info",
                                                "Medium" => "warning",
                                                "High" => "danger",
                                                _ => "secondary"
                                            })">@task.Priority</span>
                                        </td>
                                        <td>
                                            <a asp-action="TaskDetails" asp-route-id="@task.Id" class="btn btn-sm btn-info">
                                                <i class="fas fa-info-circle"></i> Details
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Team -->
        <div class="col-xl-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-users me-1"></i>
                    Project Team
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Project Manager -->
                                <tr>
                                    <td>
                                        @($"{Model.ProjectManager.FirstName} {Model.ProjectManager.LastName}")
                                        
                                    </td>
                                    <td>Project Manager</td>
                                </tr>
                                <!-- Client -->
                                <tr>
                                    <td>
                                        @($"{Model.Client.FirstName} {Model.Client.LastName}")
                                        <!-- @if (Model.ProjectManager.Id != ViewBag.CurrentUserId)
                                        {
                                            <a asp-controller="Message" asp-action="Index" asp-route-userId="@Model.ProjectManager.Id" title="Message" class="btn btn-sm btn-outline-secondary ms-2">
                                                <i class="bi bi-envelope"></i>
                                            </a>
                                        } -->
                                    </td>
                                    <td>Client</td>
                                </tr>
                                <!-- Team Members -->
                                @foreach (var member in Model.ProjectTeams)
                                {
                                    <tr>
                                        <td>
                                            @($"{member.User.FirstName} {member.User.LastName}")
                                            @* Message button removed for team members: only Project Manager should be a message recipient *@
                                        </td>
                                        <td>@member.Role</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @if (Model.IsArchived)
    {
        <form asp-action="UnarchiveProject" asp-route-id="@Model.Id" method="post" class="d-inline" onsubmit="return confirm('Reopen this project?');">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-success btn-sm">
                <i class="fas fa-folder-open"></i> Reopen Project
            </button>
        </form>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Prepare task data
            var tasks = @Html.Raw(Json.Serialize(Model.Tasks?.Select(t => new {
                id = t.Id,
                name = t.Title ?? "Untitled Task",
                start = t.StartDate.ToString("yyyy-MM-dd"),
                end = t.DueDate.ToString("yyyy-MM-dd"),
                status = t.Status ?? "Not Set",
                assignee = t.TaskAssignments != null && t.TaskAssignments.Any()
                    ? string.Join(", ", t.TaskAssignments.Select(a => a.Employee.FirstName))
                    : "Unassigned"
            }) ?? Enumerable.Empty<object>()));

            // Get project start and end dates
            var projectStart = new Date("@Model.StartDate.ToString("yyyy-MM-dd")");
            var projectEnd = new Date("@Model.EndDate?.ToString("yyyy-MM-dd")");

            // If the project's start or end date is missing or invalid, fall back to tasks' dates
            if (!projectStart || isNaN(projectStart.getTime())) {
                if (tasks && tasks.length > 0) {
                    var validStarts = tasks.filter(t => t.start).map(t => new Date(t.start).getTime());
                    if (validStarts.length > 0) {
                        projectStart = new Date(Math.min.apply(null, validStarts));
                    } else {
                        projectStart = new Date();
                    }
                } else {
                    projectStart = new Date();
                }
            }
            if (!projectEnd || isNaN(projectEnd.getTime())) {
                if (tasks && tasks.length > 0) {
                    var validEnds = tasks.filter(t => t.end).map(t => new Date(t.end).getTime());
                    if (validEnds.length > 0) {
                        projectEnd = new Date(Math.max.apply(null, validEnds));
                    } else {
                        projectEnd = new Date(projectStart.getTime() + 30 * 24 * 60 * 60 * 1000);
                    }
                } else {
                    // Default to one month after start
                    projectEnd = new Date(projectStart.getTime() + 30 * 24 * 60 * 60 * 1000);
                }
            }

            projectStart = projectStart.getTime();
            projectEnd = projectEnd.getTime();


            // Configure colors array
            const colors = ['#FF5733', '#4834d4', '#6ab04c', '#be2edd', '#22a6b3', '#eb4d4b', '#f0932b', '#686de0', '#badc58', '#130f40'];

            // Create series data
            const seriesData = tasks.map((task, index) => ({
                name: task.name,
                data: [{
                    x: ' ',
                    y: [task.start ? new Date(task.start).getTime() : projectStart, task.end ? new Date(task.end).getTime() : projectEnd],
                    status: task.status,
                    assignee: task.assignee
                }]
            }));

            // Configure the Gantt chart
            var options = {
                series: seriesData,
                chart: {
                    height: 150,
                    type: 'rangeBar',
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: false,
                            zoom: false,
                            zoomin: false,
                            zoomout: false,
                            reset: false
                        }
                        
                    },
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800
                    },
                    fontFamily: 'inherit'
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        barHeight: '50%',
                        rangeBarGroupRows: true,
                        borderRadius: 4
                    }
                },
                dataLabels: {
                    enabled: false
                },
                colors: colors,
                xaxis: {
                    type: 'datetime',
                    min: projectStart,
                    max: projectEnd,
                    labels: {
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: 'MMM yyyy',
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    }
                },
                yaxis: {
                    show: false,
                    labels: {
                        show: false
                    }
                },
                grid: {
                    row: {
                        colors: ['#f8f9fa', '#fff'],
                        opacity: 1
                    },
                    padding: {
                        top: -10,
                        right: 0,
                        bottom: -10,
                        left: 0
                    }
                },
                tooltip: {
                    custom: function({series, seriesIndex, dataPointIndex, w}) {
                        var task = w.config.series[seriesIndex].data[0];
                        var startDate = new Date(task.y[0]).toLocaleDateString();
                        var endDate = new Date(task.y[1]).toLocaleDateString();
                        return '<div class="px-3 py-2">' +
                               '<div class="mb-2"><strong>' + w.config.series[seriesIndex].name + '</strong></div>' +
                               '<div class="text-muted small">Duration: ' + startDate + ' - ' + endDate + '</div>' +
                               '<div class="mt-2"><span class="badge bg-' + 
                               (task.status === 'Completed' ? 'success' : 
                                task.status === 'In Progress' ? 'primary' : 
                                task.status === 'On Hold' ? 'warning' : 'secondary') + 
                               ' me-1">' + task.status + '</span>' +
                               (task.assignee !== 'Unassigned' ? '<span class="badge bg-info ms-1"><i class="bi bi-person me-1"></i>' + task.assignee + '</span>' : '') +
                               '</div>' +
                               '</div>';
                    }
                },
                legend: {
                    show: true,
                    position: 'top',
                    horizontalAlign: 'left',
                    fontSize: '13px',
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 2,
                        fillColors: colors
                    },
                    labels: {
                        colors: '#333'
                    },
                    itemMargin: {
                        horizontal: 15
                    },
                    containerMargin: {
                        top: 0,
                        bottom: 15
                    }
                }
            };

            // Hook AJAX for complete project button (moved outside chart options)
            const completeForm = document.getElementById('completeProjectForm');
            if (completeForm) {
                completeForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const tokenElement = completeForm.querySelector('input[name="__RequestVerificationToken"]');
                    const token = tokenElement ? tokenElement.value : null;
                    try {
                        const response = await fetch(completeForm.action, {
                            method: 'POST',
                            headers: {
                                'RequestVerificationToken': token,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        if (!response.ok) throw new Error('Network response was not ok');
                        const result = await response.json();
                        if (result && result.success) {
                            // Update status badge
                            const badge = document.getElementById('projectStatusBadge');
                            if (badge) {
                                badge.textContent = result.status;
                                badge.className = 'badge bg-success';
                            }
                            // Hide Complete/Archive/Create Task buttons and disable edit
                            const createTaskBtn = document.getElementById('createTaskBtn');
                            if (createTaskBtn) createTaskBtn.classList.add('d-none');
                            const editBtn = document.getElementById('editProjectBtn');
                            if (editBtn) editBtn.classList.add('d-none');
                            const archiveForm = document.getElementById('archiveProjectForm');
                            if (archiveForm) archiveForm.remove();
                            // Add Reopen button if not present
                            let reopenForm = document.getElementById('unarchiveProjectForm');
                            if (!reopenForm) {
                                const reopenHtml = `<button id="reopenProjectBtn" class="btn btn-success btn-sm"><i class="fas fa-folder-open"></i> Reopen Project</button>`;
                                // Append to header actions
                                const header = document.getElementById('projectActions');
                                const headerActions = header ? header.querySelector('div:last-child') : null;
                                if (headerActions) headerActions.insertAdjacentHTML('beforeend', reopenHtml);
                                // Add listener for reopening
                                const reopenBtn = document.getElementById('reopenProjectBtn');
                                if (reopenBtn) {
                                    reopenBtn.addEventListener('click', async function (e) {
                                        e.preventDefault();
                                        const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
                                        const token = tokenEl ? tokenEl.value : null;
                                        try {
                                            const response = await fetch('/ProjectManager/UnarchiveProject/' + @Model.Id, {
                                                method: 'POST',
                                                headers: { 'RequestVerificationToken': token, 'X-Requested-With': 'XMLHttpRequest' }
                                            });
                                            if (!response.ok) throw new Error('Network error');
                                            const result = await response.json();
                                            if (result && result.success) {
                                                // Restore UI controls
                                                if (createTaskBtn) createTaskBtn.classList.remove('d-none');
                                                if (archiveForm) {
                                                    // add it back? redirect for simplicity
                                                }
                                                if (editBtn) editBtn.classList.remove('d-none');
                                                // Update status badge
                                                const badge = document.getElementById('projectStatusBadge');
                                                if (badge) {
                                                    badge.textContent = result.status;
                                                    badge.className = 'badge bg-primary';
                                                }
                                                showToast('Project reopened successfully');
                                            }
                                        } catch (err) {
                                            console.error(err);
                                            showToast('Failed to reopen project');
                                        }
                                    });
                                }
                            }
                            // Optionally show notification
                            showToast('Project completed and archived');
                        }
                    } catch (err) {
                        console.error(err);
                        showToast('Failed to complete project.');
                    }
                });
            }

            // Show a simple toast/alert for notifications
            function showToast(message) {
                const container = document.createElement('div');
                container.className = 'alert alert-info alert-dismissible fade show';
                container.setAttribute('role', 'alert');
                container.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                const main = document.querySelector('.container-fluid');
                if (main) main.insertBefore(container, main.firstChild);
                setTimeout(() => { if (container) container.remove(); }, 4000);
            }

            // Render the chart
            var chart = new ApexCharts(document.querySelector("#ganttChart"), options);
            chart.render();
        });
    </script>
}